r.sessions={},r.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){let e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||r.extension.isInstalled()}return!0};var e={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){let r=window.setTimeout((function(){let r=new Error("NavigatorUserMediaError");return r.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(r)}),1e3);this.cache[r]=e,window.postMessage({type:"janusGetScreen",id:r},"*")},init:function(){let e={};this.cache=e,window.addEventListener("message",(function(r){if(r.origin==window.location.origin)if("janusGotScreen"==r.data.type&&e[r.data.id]){let t=e[r.data.id];if(delete e[r.data.id],""===r.data.sourceId){let e=new Error("NavigatorUserMediaError");e.name="You cancelled the request for permission, giving up...",t(e)}else t(null,r.data.sourceId)}else"janusGetScreenPending"==r.data.type&&(console.log("clearing ",r.data.id),window.clearTimeout(r.data.id))}))}};function r(e){if((e=e||{}).success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:r.noop,!r.initDone)return e.error("Library not initialized"),{};if(!r.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(r.log("Library initialized: "+r.initDone),!e.server)return e.error("Invalid server url"),{};let t=!1,n=null,o={},a=null,i=null,s=0,c=e.server;r.isArray(c)?(r.log("Multiple servers provided ("+c.length+"), will use the first that works"),c=null,i=e.server,r.debug(i)):0===c.indexOf("ws")?(t=!0,r.log("Using WebSockets to contact Janus: "+c)):(t=!1,r.log("Using REST API to contact Janus: "+c));let d=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],l=e.iceTransportPolicy,u=e.bundlePolicy,f=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(f=!0===e.withCredentials);let p=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(p=e.max_poll_events),p<1&&(p=1);let g=null;void 0!==e.token&&null!==e.token&&(g=e.token);let m=null;void 0!==e.apisecret&&null!==e.apisecret&&(m=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);let v=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(v=e.keepAlivePeriod),isNaN(v)&&(v=25e3);let h=6e4;function b(e){let r={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(r.high=e.high),e.medium&&(r.medium=e.medium),e.low&&(r.low=e.low)),r}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(h=e.longPollTimeout),isNaN(h)&&(h=6e4);let w=!1,y=null,S={},k=this,C=0,T={};function I(){if(null==y)return;if(r.debug("Long poll..."),!w)return void r.warn("Is the server down? (connected=false)");let t=c+"/"+y+"?rid="+(new Date).getTime();p&&(t=t+"&maxev="+p),g&&(t=t+"&token="+encodeURIComponent(g)),m&&(t=t+"&apisecret="+encodeURIComponent(m)),r.httpAPICall(t,{verb:"GET",withCredentials:f,success:R,timeout:h,error:function(t,n){if(r.error(t+":",n),C++,C>3)return w=!1,void e.error("Lost connection to the server (is it down?)");I()}})}function R(e,o){if(C=0,t||null==y||!0===o||I(),t||!r.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){const t=e.sender;if(!t)return void r.warn("Missing sender...");const n=S[t];if(!n)return void r.debug("This handle is not attached to this session");let o=e.candidate;r.debug("Got a trickled candidate on session "+y),r.debug(o);let a=n.webrtcStuff;a.pc&&a.remoteSdp?(r.debug("Adding remote candidate:",o),o&&!0!==o.completed?a.pc.addIceCandidate(o):a.pc.addIceCandidate(r.endOfCandidates)):(r.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),a.candidates||(a.candidates=[]),a.candidates.push(o),r.debug(a.candidates))}else{if("webrtcup"===e.janus){r.debug("Got a webrtcup event on session "+y),r.debug(e);const t=e.sender;if(!t)return void r.warn("Missing sender...");const n=S[t];return n?void n.webrtcState(!0):void r.debug("This handle is not attached to this session")}if("hangup"===e.janus){r.debug("Got a hangup event on session "+y),r.debug(e);const t=e.sender;if(!t)return void r.warn("Missing sender...");const n=S[t];if(!n)return void r.debug("This handle is not attached to this session");n.webrtcState(!1,e.reason),n.hangup()}else if("detached"===e.janus){r.debug("Got a detached event on session "+y),r.debug(e);const t=e.sender;if(!t)return void r.warn("Missing sender...");const n=S[t];if(!n)return;n.ondetached(),n.detach()}else if("media"===e.janus){r.debug("Got a media event on session "+y),r.debug(e);const t=e.sender;if(!t)return void r.warn("Missing sender...");const n=S[t];if(!n)return void r.debug("This handle is not attached to this session");n.mediaState(e.type,e.receiving,e.mid)}else if("slowlink"===e.janus){r.debug("Got a slowlink event on session "+y),r.debug(e);const t=e.sender;if(!t)return void r.warn("Missing sender...");const n=S[t];if(!n)return void r.debug("This handle is not attached to this session");n.slowLink(e.uplink,e.lost,e.mid)}else{if("error"===e.janus){r.error("Ooops: "+e.error.code+" "+e.error.reason),r.debug(e);let t=e.transaction;if(t){let r=T[t];r&&r(e),delete T[t]}return}if("event"===e.janus){r.debug("Got a plugin event on session "+y),r.debug(e);const t=e.sender;if(!t)return void r.warn("Missing sender...");let n=e.plugindata;if(!n)return void r.warn("Missing plugindata...");r.debug("  -- Event is coming from "+t+" ("+n.plugin+")");let o=n.data;r.debug(o);const a=S[t];if(!a)return void r.warn("This handle is not attached to this session");let i=e.jsep;i&&(r.debug("Handling SDP as well..."),r.debug(i));let s=a.onmessage;s?(r.debug("Notifying application..."),s(o,i)):r.debug("No provided notification callback")}else{if("timeout"===e.janus)return r.error("Timeout on session "+y),r.debug(e),void(t&&n.close(3504,"Gateway timeout"));r.warn("Unknown message/event  '"+e.janus+"' on session "+y),r.debug(e)}}}else{r.debug("Got a success on session "+y),r.debug(e);const t=e.transaction;if(t){const r=T[t];r&&r(e),delete T[t]}}else{r.debug("Got an ack on session "+y),r.debug(e);const t=e.transaction;if(t){const r=T[t];r&&r(e),delete T[t]}}else{r.debug("Got info on the Janus instance"),r.debug(e);const t=e.transaction;if(t){const r=T[t];r&&r(e),delete T[t]}}else r.vdebug("Got a keepalive on session "+y);else for(let r=0;r<e.length;r++)R(e[r],!0)}function A(){if(!c||!t||!w)return;a=setTimeout(A,v);let e={janus:"keepalive",session_id:y,transaction:r.randomString(12)};g&&(e.token=g),m&&(e.apisecret=m),n.send(JSON.stringify(e))}function D(d){let l=r.randomString(12),u={janus:"create",transaction:l};if(d.reconnect&&(w=!1,u.janus="claim",u.session_id=y,n&&(n.onopen=null,n.onerror=null,n.onclose=null,a&&(clearTimeout(a),a=null))),g&&(u.token=g),m&&(u.apisecret=m),!c&&r.isArray(i)&&(c=i[s],0===c.indexOf("ws")?(t=!0,r.log("Server #"+(s+1)+": trying WebSockets to contact Janus ("+c+")")):(t=!1,r.log("Server #"+(s+1)+": trying REST API to contact Janus ("+c+")"))),t){n=r.newWebSocket(c,"janus-protocol"),o={error:function(){if(r.error("Error connecting to the Janus WebSockets server... "+c),r.isArray(i)&&!d.reconnect)return s++,s===i.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(c=null,void setTimeout((function(){D(d)}),200));d.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){T[l]=function(e){if(r.debug(e),"success"!==e.janus)return r.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);a=setTimeout(A,v),w=!0,y=e.session_id?e.session_id:e.data.id,d.reconnect?r.log("Claimed session: "+y):r.log("Created session: "+y),r.sessions[y]=k,d.success()},n.send(JSON.stringify(u))},message:function(e){R(JSON.parse(e.data))},close:function(){c&&w&&(w=!1,e.error("Lost connection to the server (is it down?)"))}};for(let e in o)n.addEventListener(e,o[e])}else r.httpAPICall(c,{verb:"POST",withCredentials:f,body:u,success:function(e){if(r.debug(e),"success"!==e.janus)return r.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);w=!0,y=e.session_id?e.session_id:e.data.id,d.reconnect?r.log("Claimed session: "+y):r.log("Created session: "+y),r.sessions[y]=k,I(),d.success()},error:function(e,t){if(r.error(e+":",t),r.isArray(i)&&!d.reconnect)return s++,s===i.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(c=null,void setTimeout((function(){D(d)}),200));""===t?d.error(e+": Is the server down?"):t&&t.error?d.error(e+": "+t.error.message):d.error(e+": "+t)}})}function P(e,o){if((o=o||{}).success="function"==typeof o.success?o.success:r.noop,o.error="function"==typeof o.error?o.error:r.noop,!w)return r.warn("Is the server down? (connected=false)"),void o.error("Is the server down? (connected=false)");let a=S[e];if(!a||!a.webrtcStuff)return r.warn("Invalid handle"),void o.error("Invalid handle");let i=o.message,s=o.jsep,d=r.randomString(12),l={janus:"message",body:i,transaction:d};if(a.token&&(l.token=a.token),m&&(l.apisecret=m),s){l.jsep={type:s.type,sdp:s.sdp},s.e2ee&&(l.jsep.e2ee=!0),"hml"!==s.rid_order&&"lmh"!==s.rid_order||(l.jsep.rid_order=s.rid_order),s.force_relay&&(l.jsep.force_relay=!0);let e=null,r=a.webrtcStuff;if(r.pc){let t=r.pc.getTransceivers();if(t&&t.length>0)for(let r in t){let n=t[r];if(n&&n.sender&&n.sender.track&&"video"===n.sender.track.kind){let t=n.sender.getParameters();t&&t.encodings&&t.encodings[0]&&t.encodings[0].scalabilityMode&&(e||(e=[]),e.push({mindex:parseInt(r),mid:n.mid,svc:t.encodings[0].scalabilityMode}))}}}e&&(l.jsep.svc=e)}if(r.debug("Sending message to plugin (handle="+e+"):"),r.debug(l),t)return l.session_id=y,l.handle_id=e,T[d]=function(e){if(r.debug("Message sent!"),r.debug(e),"success"===e.janus){let t=e.plugindata;if(!t)return r.warn("Request succeeded, but missing plugindata..."),void o.success();r.log("Synchronous transaction successful ("+t.plugin+")");let n=t.data;return r.debug(n),void o.success(n)}"ack"===e.janus?o.success():e.error?(r.error("Ooops: "+e.error.code+" "+e.error.reason),o.error(e.error.code+" "+e.error.reason)):(r.error("Unknown error"),o.error("Unknown error"))},void n.send(JSON.stringify(l));r.httpAPICall(c+"/"+y+"/"+e,{verb:"POST",withCredentials:f,body:l,success:function(e){if(r.debug("Message sent!"),r.debug(e),"success"===e.janus){let t=e.plugindata;if(!t)return r.warn("Request succeeded, but missing plugindata..."),void o.success();r.log("Synchronous transaction successful ("+t.plugin+")");let n=t.data;return r.debug(n),void o.success(n)}"ack"===e.janus?o.success():e.error?(r.error("Ooops: "+e.error.code+" "+e.error.reason),o.error(e.error.code+" "+e.error.reason)):(r.error("Unknown error"),o.error("Unknown error"))},error:function(e,t){r.error(e+":",t),o.error(e+": "+t)}})}function E(e,o){if(!w)return void r.warn("Is the server down? (connected=false)");let a=S[e];if(!a||!a.webrtcStuff)return void r.warn("Invalid handle");let i={janus:"trickle",candidate:o,transaction:r.randomString(12)};if(a.token&&(i.token=a.token),m&&(i.apisecret=m),r.vdebug("Sending trickle candidate (handle="+e+"):"),r.vdebug(i),t)return i.session_id=y,i.handle_id=e,void n.send(JSON.stringify(i));r.httpAPICall(c+"/"+y+"/"+e,{verb:"POST",withCredentials:f,body:i,success:function(e){r.vdebug("Candidate sent!"),r.vdebug(e),"ack"===e.janus||r.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){r.error(e+":",t)}})}function O(e,t,n,o,a){let i=S[e];if(!i||!i.webrtcStuff)return void r.warn("Invalid handle");let s=i.webrtcStuff;if(!s.pc)return void r.warn("Invalid PeerConnection");let c=function(e){r.log("Received state change on data channel:",e);let t=e.target.label,n=e.target.protocol,o=s.dataChannel[t]?s.dataChannel[t].readyState:"null";if(r.log("State change on <"+t+"> data channel: "+o),"open"===o){if(s.dataChannel[t].pending&&s.dataChannel[t].pending.length>0){r.log("Sending pending messages on <"+t+">:",s.dataChannel[t].pending.length);for(let e of s.dataChannel[t].pending)r.log("Sending data on data channel <"+t+">"),r.debug(e),s.dataChannel[t].send(e);s.dataChannel[t].pending=[]}i.ondataopen(t,n)}};if(o)s.dataChannel[t]=o;else{let e=s.dataChannelOptions;n&&(e.protocol=n),s.dataChannel[t]=s.pc.createDataChannel(t,e)}s.dataChannel[t].onmessage=function(e){r.log("Received message on data channel:",e);let t=e.target.label;i.ondata(e.data,t)},s.dataChannel[t].onopen=c,s.dataChannel[t].onclose=c,s.dataChannel[t].onerror=function(e){r.error("Got error on data channel:",e)},s.dataChannel[t].pending=[],a&&s.dataChannel[t].pending.push(a)}function j(e,t){(t=t||{}).success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;let n=S[e];if(!n||!n.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");let o=n.webrtcStuff,a=t.text||t.data;if(!a)return r.warn("Invalid data"),void t.error("Invalid data");let i=t.label?t.label:r.dataChanDefaultLabel;return o.dataChannel[i]?"open"!==o.dataChannel[i].readyState?(o.dataChannel[i].pending.push(a),void t.success()):(r.log("Sending data on data channel <"+i+">"),r.debug(a),o.dataChannel[i].send(a),void t.success()):(O(e,i,t.protocol,!1,a,t.protocol),void t.success())}function x(e,t){(t=t||{}).success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;let n=S[e];if(!n||!n.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");let o=n.webrtcStuff;if(!o.dtmfSender){if(o.pc){let e=o.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!e)return r.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");o.dtmfSender=e.dtmf,o.dtmfSender&&(r.log("Created DTMF Sender"),o.dtmfSender.ontonechange=function(e){r.debug("Sent DTMF tone: "+e.tone)})}if(!o.dtmfSender)return r.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}let a=t.dtmf;if(!a)return r.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");let i=a.tones;if(!i)return r.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");let s="number"==typeof a.duration?a.duration:500,c="number"==typeof a.gap?a.gap:50;r.debug("Sending DTMF string "+i+" (duration "+s+"ms, gap "+c+"ms)"),o.dtmfSender.insertDTMF(i,s,c),t.success()}function M(e,o){(o=o||{}).success="function"==typeof o.success?o.success:r.noop,o.error="function"==typeof o.error?o.error:r.noop;let a=!0===o.noRequest;r.log("Destroying handle "+e+" (only-locally="+a+")"),Q(e);let i=S[e];if(!i||i.detached)return delete S[e],void o.success();if(i.detached=!0,a)return delete S[e],void o.success();if(!w)return r.warn("Is the server down? (connected=false)"),void o.error("Is the server down? (connected=false)");let s={janus:"detach",transaction:r.randomString(12)};if(i.token&&(s.token=i.token),m&&(s.apisecret=m),t)return s.session_id=y,s.handle_id=e,n.send(JSON.stringify(s)),delete S[e],void o.success();r.httpAPICall(c+"/"+y+"/"+e,{verb:"POST",withCredentials:f,body:s,success:function(t){r.log("Destroyed handle:"),r.debug(t),"success"!==t.janus&&r.error("Ooops: "+t.error.code+" "+t.error.reason),delete S[e],o.success()},error:function(t,n){r.error(t+":",n),delete S[e],o.success()}})}function N(e,t){let n=S[e];if(!n||!n.webrtcStuff)throw r.warn("Invalid handle"),"Invalid handle";let o=n.webrtcStuff;if(o.pc)return;let a={iceServers:d,iceTransportPolicy:l,bundlePolicy:u,sdpSemantics:"unified-plan"},i=!1;if(t.tracks)for(let e of t.tracks)if(e.transforms&&(e.transforms.sender||e.transforms.receiver)){i=!0;break}RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&i&&(o.insertableStreams=!0,a.forceEncodedAudioInsertableStreams=!0,a.forceEncodedVideoInsertableStreams=!0,a.encodedInsertableStreams=!0),r.log("Creating PeerConnection"),o.pc=new RTCPeerConnection(a),r.debug(o.pc),o.pc.getStats&&(o.volume={},o.bitrate.value="0 kbits/sec"),r.log("Preparing local SDP and gathering candidates (trickle="+o.trickle+")"),o.pc.oniceconnectionstatechange=function(){o.pc&&n.iceState(o.pc.iceConnectionState)},o.pc.onicecandidate=function(n){if(!n.candidate||n.candidate.candidate&&n.candidate.candidate.indexOf("endOfCandidates")>0)r.log("End of candidates."),o.iceDone=!0,!0===o.trickle?E(e,{completed:!0}):function(e,t){t=t||{},t.success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;let n=S[e];if(!n||!n.webrtcStuff)return void r.warn("Invalid handle, not sending anything");let o=n.webrtcStuff;if(r.log("Sending offer/answer SDP..."),!o.mySdp)return void r.warn("Local SDP instance is invalid, not sending anything...");o.mySdp={type:o.pc.localDescription.type,sdp:o.pc.localDescription.sdp},!1===o.trickle&&(o.mySdp.trickle=!1);r.debug(t),o.sdpSent=!0,t.success(o.mySdp)}(e,t);else{let r={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};!0===o.trickle&&E(e,r)}},o.pc.ontrack=function(e){if(r.log("Handling Remote Track",e),!e.streams)return;if(!e.track)return;let t=e.transceiver?e.transceiver.mid:e.track.id;try{n.onremotetrack(e.track,t,!0,{reason:"created"})}catch(e){r.error("Error calling onremotetrack",e)}if(e.track.onended)return;let a=null;r.log("Adding onended callback to track:",e.track),e.track.onended=function(e){r.log("Remote track removed:",e),clearTimeout(a);let t=o.pc?o.pc.getTransceivers():null,i=t?t.find((r=>r.receiver.track===e.target)):null,s=i?i.mid:e.target.id;try{n.onremotetrack(e.target,s,!1,{reason:"ended"})}catch(e){r.error("Error calling onremotetrack on removal",e)}},e.track.onmute=function(e){r.log("Remote track muted:",e),a||(a=setTimeout((function(){r.log("Removing remote track");let t=o.pc?o.pc.getTransceivers():null,i=t?t.find((r=>r.receiver.track===e.target)):null,s=i?i.mid:e.target.id;try{n.onremotetrack(e.target,s,!1,{reason:"mute"})}catch(e){r.error("Error calling onremotetrack on mute",e)}a=null}),2520))},e.track.onunmute=function(e){if(r.log("Remote track flowing again:",e),null!=a)clearTimeout(a),a=null;else try{let r=o.pc?o.pc.getTransceivers():null,t=r?r.find((r=>r.receiver.track===e.target)):null,a=t?t.mid:e.target.id;n.onremotetrack(e.target,a,!0,{reason:"unmute"})}catch(e){r.error("Error calling onremotetrack on unmute",e)}}}}async function V(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:r.noop,n.error="function"==typeof n.error?n.error:H;let o=n.jsep;if(t&&o)return r.error("Provided a JSEP to a createOffer"),void n.error("Provided a JSEP to a createOffer");if(!(t||o&&o.type&&o.sdp))return r.error("A valid JSEP is required for createAnswer"),void n.error("A valid JSEP is required for createAnswer");if(n.media&&!n.tracks){if(n.tracks=r.mediaToTracks(n.media),!0===n.simulcast||!0===n.simulcast2||n.svc)for(let e of n.tracks)if("video"===e.type){!0===n.simulcast||!0===n.simulcast2?e.simulcast=!0:n.svc&&(e.svc=n.svc);break}r.warn("Deprecated media object passed, use tracks instead. Automatically translated to:",n.tracks)}if(n.tracks&&!Array.isArray(n.tracks))return r.error("Tracks must be an array"),void n.error("Tracks must be an array");let a=S[e];if(!a||!a.webrtcStuff)return r.warn("Invalid handle"),void n.error("Invalid handle");let i=a.webrtcStuff;var s;i.trickle=(s=n.trickle,r.debug("isTrickleEnabled:",s),!1!==s);try{if(N(e,n),t&&await J(e,n),o){if(await i.pc.setRemoteDescription(o),r.log("Remote description accepted!"),i.remoteSdp=o.sdp,i.candidates&&i.candidates.length>0){for(let e=0;e<i.candidates.length;e++){let t=i.candidates[e];r.debug("Adding remote candidate:",t),t&&!0!==t.completed?i.pc.addIceCandidate(t):i.pc.addIceCandidate(r.endOfCandidates)}i.candidates=[]}await J(e,n);let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:r.noop;let n=S[e];if(!n||!n.webrtcStuff)throw r.warn("Invalid handle"),"Invalid handle";let o=n.webrtcStuff;r.log("Creating answer (iceDone="+o.iceDone+")");let a=await o.pc.createAnswer();r.debug(a);let i={type:"answer",sdp:a.sdp};if(t.customizeSdp(i),a.sdp=i.sdp,r.log("Setting local description"),o.mySdp={type:"answer",sdp:a.sdp},await o.pc.setLocalDescription(a),!o.iceDone&&!o.trickle)return r.log("Waiting for all candidates..."),null;o.insertableStreams&&(a.e2ee=!0);return a}(e,n);n.success(t)}else{let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:r.noop;let n=S[e];if(!n||!n.webrtcStuff)throw r.warn("Invalid handle"),"Invalid handle";let o=n.webrtcStuff;r.log("Creating offer (iceDone="+o.iceDone+")");let a={},i=!0===t.iceRestart;i&&(a.iceRestart=!0);r.debug(a);let s=await o.pc.createOffer(a);r.debug(s);let c={type:"offer",sdp:s.sdp};if(t.customizeSdp(c),s.sdp=c.sdp,r.log("Setting local description"),o.mySdp={type:"offer",sdp:s.sdp},await o.pc.setLocalDescription(s),o.mediaConstraints=a,!o.iceDone&&!o.trickle)return r.log("Waiting for all candidates..."),null;o.insertableStreams&&(s.e2ee=!0);return s}(e,n);n.success(t)}}catch(e){r.error(e),n.error(e)}}function L(e,t){(t=t||{}).success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:H,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:r.noop;let n=t.jsep,o=S[e];if(!o||!o.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");let a=o.webrtcStuff;if(n){if(!a.pc)return r.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");t.customizeSdp(n),a.pc.setRemoteDescription(n).then((function(){if(r.log("Remote description accepted!"),a.remoteSdp=n.sdp,a.candidates&&a.candidates.length>0){for(let e=0;e<a.candidates.length;e++){let t=a.candidates[e];r.debug("Adding remote candidate:",t),t&&!0!==t.completed?a.pc.addIceCandidate(t):a.pc.addIceCandidate(r.endOfCandidates)}a.candidates=[]}t.success()}),t.error)}else t.error("Invalid JSEP")}async function G(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop,t.tracks&&!Array.isArray(t.tracks))return r.error("Tracks must be an array"),void t.error("Tracks must be an array");for(let e of t.tracks)(e.add||!e.replace&&!e.remove)&&(e.replace=!0);try{await J(e,t),t.success()}catch(e){r.error(e),t.error(e)}}async function J(e,t){let n=S[e];if(!n||!n.webrtcStuff)throw r.warn("Invalid handle, not sending anything"),"Invalid handle";let o=n.webrtcStuff;if(!o.pc)throw r.warn("Invalid PeerConnection"),"Invalid PeerConnection";let a=t.tracks;if(!a||!Array.isArray(a)||0===a.length)return;let i=!1,s={};for(let e of a){if(delete e.gumGroup,!e.type||!["audio","video"].includes(e.type))continue;if(!e.capture||e.capture instanceof MediaStreamTrack)continue;let r=e.group?e.group:"default";s[r]||(s[r]={}),s[r][e.type]||(e.gumGroup=r,s[r][e.type]=e)}let c=Object.keys(s);for(let e of c){let r=s[e];r.audio&&r.video||(r.audio&&delete r.audio.gumGroup,r.video&&delete r.video.gumGroup,delete s[e])}let d=!!t.jsep;for(let t of a){if(!t.type){r.warn("Missing track type:",t);continue}if("data"===t.type){if(o.pc.ondatachannel){r.warn("Data channel exists already, not creating another one");continue}r.log("Creating default data channel"),O(e,r.dataChanDefaultLabel,null,!1),o.pc.ondatachannel=function(t){r.log("Data channel created by Janus:",t),O(e,t.channel.label,t.channel.protocol,t.channel)};continue}if(void 0===t.add&&null===t.add&&void 0===t.remove&&null===t.remove&&void 0===t.replace&&null===t.replace&&(t.add=!0),t.add&&t.remove||t.add&&t.remove&&t.replace){r.warn("Conflicting actions for track, ignoring:",t);continue}t.add&&t.replace?(r.warn("Both add and replace provided, falling back to replace:",t),delete t.add):t.remove&&t.replace&&(r.warn("Both remove and replace provided, falling back to remove:",t),delete t.replace);let a=t.type;"screen"===t.type&&(a="video");let c=null,l=null;if(c=t.mid?o.pc.getTransceivers().find((e=>e.mid===t.mid&&e.receiver.track.kind===a)):o.pc.getTransceivers().find((e=>e.receiver.track.kind===a)),t.replace||t.remove){if(!c){r.warn("Couldn't find a transceiver for track:",t);continue}if(!c.sender){r.warn("No sender in the transceiver for track:",t);continue}l=c.sender}if(d&&!c&&(c=o.pc.getTransceivers().find((e=>e.receiver.track.kind===a)),!c)){r.warn("Couldn't find a transceiver for track:",t);continue}let u=null,f=null;if((t.remove||t.replace)&&(r.log("Removing track from PeerConnection",t),f=l.track?l.track.id:null,await l.replaceTrack(null),f&&o.myStream)){let e=null;if("audio"===a&&o.myStream.getAudioTracks()&&o.myStream.getAudioTracks().length)for(let t of o.myStream.getAudioTracks())t.id===f&&(e=t,r.log("Removing audio track:",e));else if("video"===a&&o.myStream.getVideoTracks()&&o.myStream.getVideoTracks().length)for(let t of o.myStream.getVideoTracks())t.id===f&&(e=t,r.log("Removing video track:",e));if(e){try{o.myStream.removeTrack(e),n.onlocaltrack(e,!1)}catch(e){r.error("Error calling onlocaltrack on removal for renegotiation",e)}if(!0!==e.dontStop)try{e.stop()}catch(e){}}}if(t.capture){if(t.gumGroup&&s[t.gumGroup]&&s[t.gumGroup].stream){let e=s[t.gumGroup].stream;u="audio"===t.type?e.getAudioTracks()[0]:e.getVideoTracks()[0],delete s[t.gumGroup].stream,delete s[t.gumGroup],delete t.gumGroup}else if(t.capture instanceof MediaStreamTrack)u=t.capture;else{i||(i=!0,n.consentDialog(!0));let e=r.trackConstraints(t),o=null;if("audio"===t.type||"video"===t.type){if(t.gumGroup){let n="audio"===t.type?"video":"audio";if(s[t.gumGroup]&&s[t.gumGroup][n]){let o=s[t.gumGroup][n],a=r.trackConstraints(o);e[n]=a[n]}}o=await navigator.mediaDevices.getUserMedia(e),t.gumGroup&&e.audio&&e.video&&(s[t.gumGroup].stream=o,delete t.gumGroup)}else o=await navigator.mediaDevices.getDisplayMedia(e);u="audio"===t.type?o.getAudioTracks()[0]:o.getVideoTracks()[0]}if(t.replace){await l.replaceTrack(u);let e="sendrecv";!1!==t.recv&&"inactive"!==c.direction&&"sendonly"!==c.direction||(e="sendonly"),c.setDirection?c.setDirection(e):c.direction=e}else{if(o.myStream||(o.myStream=new MediaStream),"audio"===a||!t.simulcast&&!t.svc)l=o.pc.addTrack(u,o.myStream),c=o.pc.getTransceivers().find((e=>e.sender===l));else if(t.simulcast){if("firefox"!==r.webRTCAdapter.browserDetails.browser){r.log("Enabling rid-based simulcasting:",u);let e=b(t.simulcastMaxBitrates);c=o.pc.addTransceiver(u,{direction:"sendrecv",streams:[o.myStream],sendEncodings:t.sendEncodings||[{rid:"h",active:!0,maxBitrate:e.high},{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:e.low,scaleResolutionDownBy:4}]})}else if(r.log("Enabling Simulcasting for Firefox (RID)"),c=o.pc.addTransceiver(u,{direction:"sendrecv",streams:[o.myStream]}),l=c?c.sender:null,l){let e=l.getParameters();e||(e={});let r=b(t.simulcastMaxBitrates);e.encodings=t.sendEncodings||[{rid:"h",active:!0,maxBitrate:r.high},{rid:"m",active:!0,maxBitrate:r.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:r.low,scaleResolutionDownBy:4}],l.setParameters(e)}}else r.log("Enabling SVC ("+t.svc+"):",u),c=o.pc.addTransceiver(u,{direction:"sendrecv",streams:[o.myStream],sendEncodings:[{scalabilityMode:t.svc}]});if(l||(l=c?c.sender:null),t.codec)if("firefox"===r.webRTCAdapter.browserDetails.browser)r.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",t);else if("string"!=typeof t.codec)r.warn("Invalid codec value, ignoring for track:",t);else{let e=a+"/"+t.codec.toLowerCase(),n=RTCRtpReceiver.getCapabilities(a).codecs.filter((function(r){return r.mimeType.toLowerCase()===e}));if(n&&0!==n.length){if(c)try{c.setCodecPreferences(n)}catch(e){r.warn("Failed enforcing codec for this "+a+" track:",e)}}else r.warn("Codec not supported in this browser for this track, ignoring:",t)}if(t.bitrate)if(t.simulcast||t.svc)r.warn("Ignoring bitrate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(t.bitrate)||t.bitrate<0)r.warn("Ignoring invalid bitrate for track:",t);else if(l){let e=l.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxBitrate=t.bitrate,await l.setParameters(e)):r.warn("No encodings in the sender parameters, ignoring bitrate for track:",t)}if("video"===a&&t.framerate)if(t.simulcast||t.svc)r.warn("Ignoring framerate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(t.framerate)||t.framerate<0)r.warn("Ignoring invalid framerate for track:",t);else if(l){let e=l.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxFramerate=t.framerate,await l.setParameters(e)):r.warn("No encodings in the sender parameters, ignoring framerate for track:",t)}if(t.transforms){if(l&&t.transforms.sender){let e=null;RTCRtpSender.prototype.createEncodedStreams?e=l.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===a?e=l.createEncodedAudioStreams():"video"===a&&(e=l.createEncodedVideoStreams())),e&&(console.log("Insertable Streams sender transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(t.transforms.sender).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(t.transforms.sender).pipeTo(e.writable))}if(c&&c.receiver&&t.transforms.receiver){let e=null;RTCRtpReceiver.prototype.createEncodedStreams?e=c.receiver.createEncodedStreams():(RTCRtpReceiver.prototype.createAudioEncodedStreams||RTCRtpReceiver.prototype.createEncodedVideoStreams)&&("audio"===a?e=c.receiver.createEncodedAudioStreams():"video"===a&&(e=c.receiver.createEncodedVideoStreams())),e&&(console.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(t.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(t.transforms.receiver).pipeTo(e.writable))}}}u&&!0===t.dontStop&&(u.dontStop=!0)}else if(t.recv&&!c&&(c=o.pc.addTransceiver(a),c)){if(t.codec)if("firefox"===r.webRTCAdapter.browserDetails.browser)r.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",t);else if("string"!=typeof t.codec)r.warn("Invalid codec value, ignoring for track:",t);else{let e=a+"/"+t.codec.toLowerCase(),n=RTCRtpReceiver.getCapabilities(a).codecs.filter((function(r){return r.mimeType.toLowerCase()===e}));if(n&&0!==n.length)try{c.setCodecPreferences(n)}catch(e){r.warn("Failed enforcing codec for this "+a+" track:",e)}else r.warn("Codec not supported in this browser for this track, ignoring:",t)}if(c.receiver&&t.transforms&&t.transforms.receiver){let e=null;RTCRtpReceiver.prototype.createEncodedStreams?e=c.receiver.createEncodedStreams():(RTCRtpReceiver.prototype.createAudioEncodedStreams||RTCRtpReceiver.prototype.createEncodedVideoStreams)&&("audio"===a?e=c.receiver.createEncodedAudioStreams():"video"===a&&(e=c.receiver.createEncodedVideoStreams())),e&&(console.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(t.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(t.transforms.receiver).pipeTo(e.writable))}}if(u){o.myStream.addTrack(u),u.onended=function(e){r.log("Local track removed:",e);try{n.onlocaltrack(e.target,!1)}catch(e){r.error("Error calling onlocaltrack following end",e)}};try{n.onlocaltrack(u,!0)}catch(e){r.error("Error calling onlocaltrack for track add",e)}}if(c){let e=c.direction,n=null,o=u&&c.sender.track,a=!1!==t.recv&&c.receiver.track;o&&a?n="sendrecv":o&&!a?n="sendonly":!o&&a?n="recvonly":o||a||(n="inactive"),n&&n!==e&&(r.warn("Changing direction of transceiver to "+n+" (was "+e+")",t),c.setDirection?c.setDirection(n):c.direction=n)}}i&&n.consentDialog(!1)}function _(e){let t=S[e];if(!t||!t.webrtcStuff)return r.warn("Invalid handle"),null;let n=t.webrtcStuff;if(!n.pc)return r.warn("Invalid PeerConnection"),null;let o=[],a=n.pc.getTransceivers();for(let e of a){let r=null;e.sender&&e.sender.track&&(r={mid:e.mid},r.type=e.sender.track.kind,r.id=e.sender.track.id,r.label=e.sender.track.label),r&&o.push(r)}return o}function F(e){let t=S[e];if(!t||!t.webrtcStuff)return r.warn("Invalid handle"),null;let n=t.webrtcStuff;if(!n.pc)return r.warn("Invalid PeerConnection"),null;let o=[],a=n.pc.getTransceivers();for(let e of a){let r=null;e.receiver&&e.receiver.track&&(r={mid:e.mid},r.type=e.receiver.track.kind,r.id=e.receiver.track.id,r.label=e.receiver.track.label),r&&o.push(r)}return o}function U(e,t,n,o){o="function"==typeof o?o:r.noop;let a=S[e];if(!a||!a.webrtcStuff)return r.warn("Invalid handle"),void o(0);let i=n?"remote":"local",s=a.webrtcStuff;if(s.volume[i]||(s.volume[i]={value:0}),s.pc&&s.pc.getStats&&("chrome"===r.webRTCAdapter.browserDetails.browser||"safari"===r.webRTCAdapter.browserDetails.browser)){let e=s.pc;if(t){let a=s.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));if(!a)return r.warn("No audio transceiver with mid "+t),void o(0);if(n&&!a.receiver)return r.warn("Remote transceiver track unavailable"),void o(0);if(!n&&!a.sender)return r.warn("Local transceiver track unavailable"),void o(0);e=n?a.receiver:a.sender}return e.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(n&&!e.remoteSource||!n&&"media-source"!==e.type||o(e.audioLevel?e.audioLevel:0))}))})),s.volume[i].value}return r.warn("Getting the "+i+" volume unsupported by browser"),void o(0)}function W(e,t,n){let o=S[e];if(!o||!o.webrtcStuff)return r.warn("Invalid handle"),!0;let a=o.webrtcStuff;if(!a.pc)return r.warn("Invalid PeerConnection"),!0;if(!a.myStream)return r.warn("Invalid local MediaStream"),!0;if(n){if(!a.myStream.getVideoTracks()||0===a.myStream.getVideoTracks().length)return r.warn("No video track"),!0;if(t){let e=a.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(r.warn("No video sender with mid "+t),!0):(r.warn("No video transceiver with mid "+t),!0)}return!a.myStream.getVideoTracks()[0].enabled}if(!a.myStream.getAudioTracks()||0===a.myStream.getAudioTracks().length)return r.warn("No audio track"),!0;if(t){let e=a.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(r.warn("No audio sender with mid "+t),!0):(r.warn("No audio transceiver with mid "+t),!0)}return!a.myStream.getAudioTracks()[0].enabled}function B(e,t,n,o){let a=S[e];if(!a||!a.webrtcStuff)return r.warn("Invalid handle"),!1;let i=a.webrtcStuff;if(!i.pc)return r.warn("Invalid PeerConnection"),!1;if(!i.myStream)return r.warn("Invalid local MediaStream"),!1;if(n){if(!i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length)return r.warn("No video track"),!1;if(t){let e=i.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));if(!e)return r.warn("No video transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return r.warn("No video sender with mid "+t),!1;e.sender.track.enabled=!o}else for(const e of i.myStream.getVideoTracks())e.enabled=!o}else{if(!i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length)return r.warn("No audio track"),!1;if(t){let e=i.pc.getTransceivers().find((e=>e.mid===t&&"audio"===e.receiver.track.kind));if(!e)return r.warn("No audio transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return r.warn("No audio sender with mid "+t),!1;e.sender.track.enabled=!o}else for(const e of i.myStream.getAudioTracks())e.enabled=!o}return!0}function z(e,t){let n=S[e];if(!n||!n.webrtcStuff)return r.warn("Invalid handle"),"Invalid handle";let o=n.webrtcStuff;if(!o.pc)return"Invalid PeerConnection";if(o.pc.getStats){let e=o.pc,n=t||"default";if(t){let n=o.pc.getTransceivers().find((e=>e.mid===t&&"video"===e.receiver.track.kind));if(!n)return r.warn("No video transceiver with mid "+t),"No video transceiver with mid "+t;if(!n.receiver)return r.warn("No video receiver with mid "+t),"No video receiver with mid "+t;e=n.receiver}return o.bitrate[n]||(o.bitrate[n]={timer:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,value:"0 kbits/sec"}),o.bitrate[n].timer?o.bitrate[n].value:(r.log("Starting bitrate timer"+(t?" for mid "+t:"")+" (via getStats)"),o.bitrate[n].timer=setInterval((function(){e.getStats().then((function(e){e.forEach((function(e){if(!e)return;let t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(o.bitrate[n].bsnow=e.bytesReceived,o.bitrate[n].tsnow=e.timestamp,null===o.bitrate[n].bsbefore||null===o.bitrate[n].tsbefore)o.bitrate[n].bsbefore=o.bitrate[n].bsnow,o.bitrate[n].tsbefore=o.bitrate[n].tsnow;else{let e=o.bitrate[n].tsnow-o.bitrate[n].tsbefore;"safari"===r.webRTCAdapter.browserDetails.browser&&(e/=1e3);let t=Math.round(8*(o.bitrate[n].bsnow-o.bitrate[n].bsbefore)/e);"safari"===r.webRTCAdapter.browserDetails.browser&&(t=parseInt(t/1e3)),o.bitrate[n].value=t+" kbits/sec",o.bitrate[n].bsbefore=o.bitrate[n].bsnow,o.bitrate[n].tsbefore=o.bitrate[n].tsnow}}))}))}),1e3),"0 kbits/sec")}return r.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function q(e,t,n){let o=S[e];if(!o||!o.webrtcStuff)return void r.warn("Invalid handle");let a=o.webrtcStuff;if(!a.pc)return void r.warn("Invalid PeerConnection");let i=a.pc.getTransceivers().find((e=>e.mid===t));if(!i)return void r.warn("No transceiver with mid",t);if(!i.sender)return void r.warn("No sender for transceiver with mid",t);let s=i.sender.getParameters();s&&s.encodings&&0!==s.encodings.length?s.encodings.length>1?r.warn("Ignoring bitrate for simulcast track, use sendEncodings for that"):isNaN(n)||n<0?r.warn("Invalid bitrate (must be a positive integer)"):(s.encodings[0].maxBitrate=n,i.sender.setParameters(s)):r.warn("No parameters encodings")}function H(e){r.error("WebRTC error:",e)}function Q(e,o){r.log("Cleaning WebRTC stuff");let a=S[e];if(!a)return;let i=a.webrtcStuff;if(i){if(!0===o){let o={janus:"hangup",transaction:r.randomString(12)};a.token&&(o.token=a.token),m&&(o.apisecret=m),r.debug("Sending hangup request (handle="+e+"):"),r.debug(o),t?(o.session_id=y,o.handle_id=e,n.send(JSON.stringify(o))):r.httpAPICall(c+"/"+y+"/"+e,{verb:"POST",withCredentials:f,body:o})}i.volume&&(i.volume.local&&i.volume.local.timer&&clearInterval(i.volume.local.timer),i.volume.remote&&i.volume.remote.timer&&clearInterval(i.volume.remote.timer));for(let e in i.bitrate)i.bitrate[e].timer&&clearInterval(i.bitrate[e].timer);i.bitrate={},!i.streamExternal&&i.myStream&&(r.log("Stopping local stream tracks"),r.stopAllTracks(i.myStream)),i.streamExternal=!1,i.myStream=null;try{i.pc.close()}catch(e){}i.pc=null,i.candidates=null,i.mySdp=null,i.remoteSdp=null,i.iceDone=!1,i.dataChannel={},i.dtmfSender=null,i.insertableStreams=!1}a.oncleanup()}D(e),this.getServer=function(){return c},this.isConnected=function(){return w},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,e.reconnect=!0,D(e)},this.getSessionId=function(){return y},this.getInfo=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,r.log("Getting info on Janus instance"),!w)return r.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let o=r.randomString(12),a={janus:"info",transaction:o};g&&(a.token=g);m&&(a.apisecret=m);if(t)return T[o]=function(t){r.log("Server info:"),r.debug(t),"server_info"!==t.janus&&r.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},void n.send(JSON.stringify(a));r.httpAPICall(c,{verb:"POST",withCredentials:f,body:a,success:function(t){r.log("Server info:"),r.debug(t),"server_info"!==t.janus&&r.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},error:function(t,n){r.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)},this.destroy=function(i){!function(i){i=i||{},i.success="function"==typeof i.success?i.success:r.noop,i.error="function"==typeof i.error?i.error:r.noop;let s=!0===i.unload,d=!0;void 0!==i.notifyDestroyed&&null!==i.notifyDestroyed&&(d=!0===i.notifyDestroyed);let l=!0===i.cleanupHandles;if(r.log("Destroying session "+y+" (unload="+s+")"),!y)return r.warn("No session to destroy"),i.success(),void(d&&e.destroyed());if(l)for(let e in S)M(e,{noRequest:!0});if(!w)return r.warn("Is the server down? (connected=false)"),y=null,void i.success();let u={janus:"destroy",transaction:r.randomString(12)};g&&(u.token=g);m&&(u.apisecret=m);if(s)return t?(n.onclose=null,n.close(),n=null):navigator.sendBeacon(c+"/"+y,JSON.stringify(u)),r.log("Destroyed session:"),y=null,w=!1,i.success(),void(d&&e.destroyed());if(t){u.session_id=y;let r=function(){for(let e in o)n.removeEventListener(e,o[e]);n.removeEventListener("message",t),n.removeEventListener("error",s),a&&clearTimeout(a),n.close()},t=function(t){let n=JSON.parse(t.data);n.session_id==u.session_id&&n.transaction==u.transaction&&(r(),i.success(),d&&e.destroyed())},s=function(){r(),i.error("Failed to destroy the server: Is the server down?"),d&&e.destroyed()};return n.addEventListener("message",t),n.addEventListener("error",s),void(1===n.readyState?n.send(JSON.stringify(u)):s())}r.httpAPICall(c+"/"+y,{verb:"POST",withCredentials:f,body:u,success:function(t){r.log("Destroyed session:"),r.debug(t),y=null,w=!1,"success"!==t.janus&&r.error("Ooops: "+t.error.code+" "+t.error.reason),i.success(),d&&e.destroyed()},error:function(t,n){r.error(t+":",n),y=null,w=!1,i.success(),d&&e.destroyed()}})}(i)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,e.dataChannelOptions=e.dataChannelOptions||{ordered:!0},e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:r.noop,e.iceState="function"==typeof e.iceState?e.iceState:r.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:r.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:r.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:r.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:r.noop,e.onlocaltrack="function"==typeof e.onlocaltrack?e.onlocaltrack:r.noop,e.onremotetrack="function"==typeof e.onremotetrack?e.onremotetrack:r.noop,e.ondata="function"==typeof e.ondata?e.ondata:r.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:r.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:r.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:r.noop,!w)return r.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let o=e.plugin;if(!o)return r.error("Invalid plugin"),void e.error("Invalid plugin");let a=e.opaqueId,i=e.loopIndex,s=e.token?e.token:g,d=r.randomString(12),l={janus:"attach",plugin:o,opaque_id:a,loop_index:i,transaction:d};s&&(l.token=s);m&&(l.apisecret=m);if(t)return T[d]=function(t){if(r.debug(t),"success"!==t.janus)return r.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);let n=t.data.id;r.log("Created handle: "+n);let a={session:k,plugin:o,id:n,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return n},getPlugin:function(){return o},getVolume:function(e,r){return U(n,e,!0,r)},getRemoteVolume:function(e,r){return U(n,e,!0,r)},getLocalVolume:function(e,r){return U(n,e,!1,r)},isAudioMuted:function(e){return W(n,e,!1)},muteAudio:function(e){return B(n,e,!1,!0)},unmuteAudio:function(e){return B(n,e,!1,!1)},isVideoMuted:function(e){return W(n,e,!0)},muteVideo:function(e){return B(n,e,!0,!0)},unmuteVideo:function(e){return B(n,e,!0,!1)},getBitrate:function(e){return z(n,e)},setMaxBitrate:function(e,r){return q(n,e,r)},send:function(e){P(n,e)},data:function(e){j(n,e)},dtmf:function(e){x(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){V(n,!0,e)},createAnswer:function(e){V(n,!1,e)},handleRemoteJsep:function(e){L(n,e)},replaceTracks:function(e){G(n,e)},getLocalTracks:function(){return _(n)},getRemoteTracks:function(){return F(n)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){Q(n,!0===e)},detach:function(e){M(n,e)}};S[n]=a,e.success(a)},l.session_id=y,void n.send(JSON.stringify(l));r.httpAPICall(c+"/"+y,{verb:"POST",withCredentials:f,body:l,success:function(t){if(r.debug(t),"success"!==t.janus)return r.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);let n=t.data.id;r.log("Created handle: "+n);let a={session:k,plugin:o,id:n,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return n},getPlugin:function(){return o},getVolume:function(e,r){return U(n,e,!0,r)},getRemoteVolume:function(e,r){return U(n,e,!0,r)},getLocalVolume:function(e,r){return U(n,e,!1,r)},isAudioMuted:function(e){return W(n,e,!1)},muteAudio:function(e){return B(n,e,!1,!0)},unmuteAudio:function(e){return B(n,e,!1,!1)},isVideoMuted:function(e){return W(n,e,!0)},muteVideo:function(e){return B(n,e,!0,!0)},unmuteVideo:function(e){return B(n,e,!0,!1)},getBitrate:function(e){return z(n,e)},setMaxBitrate:function(e,r){return q(n,e,r)},send:function(e){P(n,e)},data:function(e){j(n,e)},dtmf:function(e){x(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){V(n,!0,e)},createAnswer:function(e){V(n,!1,e)},handleRemoteJsep:function(e){L(n,e)},replaceTracks:function(e){G(n,e)},getLocalTracks:function(){return _(n)},getRemoteTracks:function(){return F(n)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){Q(n,!0===e)},detach:function(e){M(n,e)}};S[n]=a,e.success(a)},error:function(t,n){r.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)}}r.useDefaultDependencies=function(t){let n=t&&t.fetch||fetch,o=t&&t.Promise||Promise,a=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,r){return new a(e,r)},extension:t&&t.extension||e,isArray:function(e){return Array.isArray(e)},webRTCAdapter:t&&t.adapter||adapter,httpAPICall:function(e,t){let a={method:t.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===t.verb&&(a.headers["Content-Type"]="application/json"),void 0!==t.withCredentials&&(a.credentials=!0===t.withCredentials?"include":t.withCredentials?t.withCredentials:"omit"),t.body&&(a.body=JSON.stringify(t.body));let i=n(e,a).catch((function(e){return o.reject({message:"Probably a network error, is the server down?",error:e})}));if(t.timeout){let e=new o((function(e,r){let n=setTimeout((function(){return clearTimeout(n),r({message:"Request timed out",timeout:t.timeout})}),t.timeout)}));i=o.race([i,e])}return i.then((function(e){return e.ok?typeof t.success==typeof r.noop?e.json().then((function(e){try{t.success(e)}catch(e){r.error("Unhandled httpAPICall success callback error",e)}}),(function(r){return o.reject({message:"Failed to parse response body",error:r,response:e})})):void 0:o.reject({message:"API call failed",response:e})})).catch((function(e){typeof t.error==typeof r.noop&&t.error(e.message||"<< internal error >>",e)})),i}}},r.useOldDependencies=function(t){let n=t&&t.jQuery||jQuery,o=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,r){return new o(e,r)},isArray:function(e){return n.isArray(e)},extension:t&&t.extension||e,webRTCAdapter:t&&t.adapter||adapter,httpAPICall:function(e,t){let o=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},a=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return n.ajax(n.extend(o,a,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof r.noop&&t.success(e)},error:function(e,n,o){typeof t.error==typeof r.noop&&t.error(n,o)}}))}}},r.mediaToTracks=function(e){let r=[];if(e){if(!e.keepAudio&&!1!==e.audio&&(void 0===e.audio||e.audio||e.audioSend||e.audioRecv||e.addAudio||e.replaceAudio||e.removeAudio)){let t={type:"audio"};e.removeAudio?t.remove=!0:(e.addAudio?t.add=!0:e.replaceAudio&&(t.replace=!0),!1!==e.audioSend&&(t.capture=e.audio||!0),!1!==e.audioRecv&&(t.recv=!0)),(t.remove||t.capture||t.recv)&&r.push(t)}if(!e.keepVideo&&!1!==e.video&&(void 0===e.video||e.video||e.videoSend||e.videoRecv||e.addVideo||e.replaceVideo||e.removeVideo)){let t={type:"video"};e.removeVideo?t.remove=!0:(e.addVideo?t.add=!0:e.replaceVideo&&(t.replace=!0),!1!==e.videoSend&&(t.capture=e.video||!0,["screen","window","desktop"].includes(t.capture)&&(t.type="screen",t.capture={video:{}},e.screenshareFrameRate&&(t.capture.frameRate=e.screenshareFrameRate),e.screenshareHeight&&(t.capture.height=e.screenshareHeight),e.screenshareWidth&&(t.capture.width=e.screenshareWidth))),!1!==e.videoRecv&&(t.recv=!0)),(t.remove||t.capture||t.recv)&&r.push(t)}e.data&&r.push({type:"data"})}else r.push({type:"audio",capture:!0,recv:!0}),r.push({type:"video",capture:!0,recv:!0});return r},r.trackConstraints=function(e){let t={};if(!e||!e.capture)return t;if("audio"===e.type)t.audio=e.capture;else if("video"===e.type)if((e.simulcast||e.svc)&&!0===e.capture&&(e.capture="hires"),!0===e.capture||"object"==typeof e.capture)t.video=e.capture;else{let n=0,o=0;"lowres"===e.capture?(n=320,o=240):"lowres-16:9"===e.capture?(n=320,o=180):"hires"===e.capture||"hires-16:9"===e.capture||"hdres"===e.capture?(n=1280,o=720):"fhdres"===e.capture?(n=1920,o=1080):"4kres"===e.capture?(n=3840,o=2160):"stdres"===e.capture?(n=640,o=480):"stdres-16:9"===e.capture?(n=640,o=360):(r.log("Default video setting is stdres 4:3"),n=640,o=480),t.video={width:{ideal:n},height:{ideal:o}}}else"screen"===e.type&&(t.video=e.capture);return t},r.noop=function(){},r.dataChanDefaultLabel="JanusDataChannel",r.endOfCandidates=null,r.stopAllTracks=function(e){try{let t=e.getTracks();for(let e of t)r.log(e),e&&!0!==e.dontStop&&e.stop()}catch(e){}},r.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:r.noop,r.initDone)e.callback();else{if(void 0===console.log&&(console.log=function(){}),r.trace=r.noop,r.debug=r.noop,r.vdebug=r.noop,r.log=r.noop,r.warn=r.noop,r.error=r.noop,!0===e.debug||"all"===e.debug)r.trace=console.trace.bind(console),r.debug=console.debug.bind(console),r.vdebug=console.debug.bind(console),r.log=console.log.bind(console),r.warn=console.warn.bind(console),r.error=console.error.bind(console);else if(Array.isArray(e.debug))for(let t of e.debug)switch(t){case"trace":r.trace=console.trace.bind(console);break;case"debug":r.debug=console.debug.bind(console);break;case"vdebug":r.vdebug=console.debug.bind(console);break;case"log":r.log=console.log.bind(console);break;case"warn":r.warn=console.warn.bind(console);break;case"error":r.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}r.log("Initializing library");let t=e.dependencies||r.useDefaultDependencies();r.isArray=t.isArray,r.webRTCAdapter=t.webRTCAdapter,r.httpAPICall=t.httpAPICall,r.newWebSocket=t.newWebSocket,r.extension=t.extension,r.extension.init(),r.listDevices=function(e,t){e="function"==typeof e?e:r.noop,t||(t={audio:!0,video:!0}),r.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(t).then((function(t){navigator.mediaDevices.enumerateDevices().then((function(n){r.debug(n),e(n),r.stopAllTracks(t)}))})).catch((function(t){r.error(t),e([])})):(r.warn("navigator.mediaDevices unavailable"),e([]))},r.attachMediaStream=function(e,t){try{e.srcObject=t}catch(n){try{e.src=URL.createObjectURL(t)}catch(e){r.error("Error attaching stream to element",e)}}},r.reattachMediaStream=function(e,t){try{e.srcObject=t.srcObject}catch(n){try{e.src=t.src}catch(e){r.error("Error reattaching stream to element",e)}}};let n=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",o=window["on"+n];if(window.addEventListener(n,(function(){r.log("Closing window");for(let e in r.sessions)r.sessions[e]&&r.sessions[e].destroyOnUnload&&(r.log("Destroying session "+e),r.sessions[e].destroy({unload:!0,notifyDestroyed:!1}));o&&"function"==typeof o&&o()})),r.safariVp8=!1,"safari"===r.webRTCAdapter.browserDetails.browser&&r.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(let e of RTCRtpSender.getCapabilities("video").codecs)if(e&&e.mimeType&&"video/vp8"===e.mimeType.toLowerCase()){r.safariVp8=!0;break}r.safariVp8?r.log("This version of Safari supports VP8"):r.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{let e=new RTCPeerConnection({});e.createOffer({offerToReceiveVideo:!0}).then((function(t){r.safariVp8=-1!==t.sdp.indexOf("VP8"),r.safariVp8?r.log("This version of Safari supports VP8"):r.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),e.close(),e=null}))}r.initDone=!0,e.callback()}},r.isWebrtcSupported=function(){return!!window.RTCPeerConnection},r.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},r.randomString=function(e){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let n=0;n<e;n++){let e=Math.floor(62*Math.random());t+=r.charAt(e)}return t};export{r as default};
